#
# Copyright (C) 2021-2022 Confluent, Inc.
#

version: v1.0
name: Publish to JFrog
agent:
    machine:
        type: s1-prod-ubuntu20-04-amd64-1

global_job_config:
    env_vars:
        - name: MAVEN_OPTS
          value: "-Dmaven.repo.local=.m2"
    secrets:
        - name: vault_sem2_approle
    prologue:
        commands:
            - chmod 400 ~/.ssh/id_rsa
            - checkout
            - make install-vault
            - . mk-include/bin/vault-setup
            - . vault-sem-get-secret semaphore-secrets-global
            - . vault-sem-get-secret aws_credentials
            - . vault-sem-get-secret ssh_id_rsa
            - . vault-sem-get-secret netrc
            - . vault-sem-get-secret ssh_config
            - . vault-sem-get-secret gitconfig
            - . vault-sem-get-secret maven-settings
            - chmod 700 ~/.m2/settings.xml
            - chmod 700 ~/.netrc
            - sem-version java 11

blocks:
    - name: Deploy to JFrog
      task:
          jobs:
              - name: Publish Artifacts
                commands:
                    - checkout
                    - cache restore
                    # Download all JARs possible and compile as much as possible
                    # Use -q to reduce output spam
                    - ./mvnw -DskipTests -Ppublish-to-jfrog deploy

after_pipeline:
    task:
        jobs:
            - name: Publish Results
              commands:
                  - test-results gen-pipeline-report
